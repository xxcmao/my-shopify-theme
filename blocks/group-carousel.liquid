{%- comment -%}
  Group carousel block — vG-Carousel-1.7.0
  - 基于原来的 group block，增加横向滑动能力
  - slide_width：控制每个 slide 占视口宽度的百分比
  - show_scrollbar：开关滚动条显示
  - auto_scroll_enabled + auto_scroll_interval：可选自动轮播（一次移动一个卡片宽度）
  - 自动轮播行为：
    * 每次移动 1 个卡片距离
    * 播放到最后一屏后，停留一个间隔，再回到第 1 屏，循环
{%- endcomment -%}

{%- capture children -%}
  <div class="group-carousel__viewport{% unless block.settings.show_scrollbar %} group-carousel__viewport--no-scrollbar{% endunless %}">
    <div
      class="group-carousel__track group-carousel__track--force"
      style="
        --group-carousel-gap: {{ block.settings.gap }}px;
        --group-carousel-slide-width: {{ block.settings.slide_width | default: 100 }}%;
      "
    >
      {% content_for 'blocks' %}
    </div>
  </div>
{%- endcapture -%}

<div
  class="group-carousel-block"
  data-auto-scroll="{{ block.settings.auto_scroll_enabled }}"
  data-auto-scroll-interval="{{ block.settings.auto_scroll_interval | default: 4 }}"
  {{ block.shopify_attributes }}
>
  {% render 'group',
    children: children,
    settings: block.settings,
    shopify_attributes: block.shopify_attributes
  %}
</div>

{% stylesheet %}
  .group-carousel-block {
    width: 100%;
  }

  /* 确保 group 外壳本身占满所在列，避免 shrink-to-fit 导致没有 overflow */
  .group-carousel-block > .group {
    width: 100% !important;
    max-width: 100% !important;
  }

  .group-carousel__viewport {
    width: 100%;
    max-width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x mandatory;

    /* Firefox 滚动条样式：thumb 灰色，track 透明 */
    scrollbar-width: thin;
    scrollbar-color: #a6a6a6 transparent;
  }

  .group-carousel__track {
    display: flex;
    gap: var(--group-carousel-gap, 16px);
    padding-block: 0.25rem;
  }

  /* 强制不换行，超出才产生横向滚动 */
  .group-carousel__track--force {
    flex-wrap: nowrap !important;
  }

  /* 直接子 block = 每一个 slide，宽度由变量控制 */
  .group-carousel__track--force > * {
    flex: 0 0 var(--group-carousel-slide-width, 100%) !important;
    min-width: var(--group-carousel-slide-width, 100%) !important;
    max-width: var(--group-carousel-slide-width, 100%) !important;
    scroll-snap-align: start;
  }

  /* 尽量让常见卡片类控件铺满 slide */
  .group-carousel__track--force .product-card,
  .group-carousel__track--force .product-card-custom,
  .group-carousel__track--force .resource-list__item,
  .group-carousel__track--force .group {
    width: 100% !important;
    max-width: 100% !important;
    margin-inline: 0 !important;
  }

  @media (max-width: 749px) {
    /* 目前移动端沿用同一个 slide 宽度，有需要可以再加 mobile 专用变量 */
    .group-carousel__track--force > * {
      flex-basis: var(--group-carousel-slide-width, 100%) !important;
      min-width: var(--group-carousel-slide-width, 100%) !important;
    }
  }

  /* WebKit 内核（Chrome / Safari / Edge）——横向滚动条样式 */
  .group-carousel__viewport::-webkit-scrollbar {
    height: 6px; /* 滚动条高度 */
  }

  .group-carousel__viewport::-webkit-scrollbar-track {
    background-color: transparent; /* 横条背景透明 */
  }

  .group-carousel__viewport::-webkit-scrollbar-thumb {
    background-color: #a6a6a6; /* 滚动块稍深灰 */
    border-radius: 999px;
  }

  .group-carousel__viewport::-webkit-scrollbar-thumb:hover {
    background-color: #8c8c8c; /* 悬停时略深一点 */
  }

  /* 当 show_scrollbar = false 时，隐藏滚动条（仍可滚动） */
  .group-carousel__viewport--no-scrollbar {
    -ms-overflow-style: none;    /* 旧版 Edge / IE */
    scrollbar-width: none;       /* Firefox */
  }
  .group-carousel__viewport--no-scrollbar::-webkit-scrollbar {
    display: none;               /* WebKit */
  }
{% endstylesheet %}

{% javascript %}
  (function() {
    function initAutoScrollForCarousel(container) {
      // 防止重复初始化
      if (container._groupCarouselAutoScrollInitialized) return;
      container._groupCarouselAutoScrollInitialized = true;

      var autoScrollAttr = container.getAttribute('data-auto-scroll');
      if (!(autoScrollAttr === 'true' || autoScrollAttr === '1')) {
        return;
      }

      var viewport = container.querySelector('.group-carousel__viewport');
      var track = container.querySelector('.group-carousel__track');
      if (!viewport || !track) return;

      var slides = track.children;
      if (!slides || slides.length <= 1) return; // 一张卡就没必要自动滚

      var intervalSec = parseFloat(container.getAttribute('data-auto-scroll-interval') || '4');
      if (isNaN(intervalSec) || intervalSec <= 0) intervalSec = 4;
      var interval = intervalSec * 1000;

      var slidePositions = [];
      var maxScrollLeft = 0;
      var currentIndex = 0;
      var pausedAtEnd = false; // 是否已经在最后一屏“暂停过一轮”

      function computePositions() {
        slidePositions = [];
        maxScrollLeft = Math.max(0, track.scrollWidth - viewport.clientWidth);

        // 如果没有横向滚动空间，就不启用自动轮播
        if (maxScrollLeft <= 0) {
          slidePositions = [];
          return;
        }

        for (var i = 0; i < slides.length; i++) {
          slidePositions.push(slides[i].offsetLeft);
        }
      }

      computePositions();
      if (!slidePositions.length) {
        return; // 没可滚动空间，直接退出
      }

      viewport.scrollLeft = slidePositions[0];

      var timer;

      function step() {
        // 如果这个 block 已经被移出 DOM，就清理定时器
        if (!document.body.contains(container)) {
          clearInterval(timer);
          if (container._groupCarouselResizeObserver) {
            container._groupCarouselResizeObserver.disconnect();
          }
          window.removeEventListener('resize', computePositions);
          return;
        }

        // 如果因为响应式变化导致之前的计算失效，重新计算
        if (!slidePositions.length || maxScrollLeft <= 0) {
          computePositions();
          if (!slidePositions.length || maxScrollLeft <= 0) {
            return;
          }
        }

        var scrollLeft = viewport.scrollLeft;
        var atEnd = Math.abs(scrollLeft - maxScrollLeft) < 2; // 接近最右端视为“末尾”

        // —— 末尾逻辑：先停一轮，再回到第 1 屏 ——
        if (atEnd) {
          if (!pausedAtEnd) {
            // 第一次到达末尾：记录一次暂停，这一轮什么都不动
            pausedAtEnd = true;
            return;
          } else {
            // 第二次轮到末尾：回到第 1 屏，并清除暂停状态
            pausedAtEnd = false;
            currentIndex = 0;

            var targetStart = slidePositions[0];
            if (viewport.scrollTo) {
              viewport.scrollTo({
                left: targetStart,
                behavior: 'smooth'
              });
            } else {
              viewport.scrollLeft = targetStart;
            }
            return;
          }
        }

        // —— 非末尾：根据当前 scrollLeft 找最近的 slide，向后移动一张 ——
        var closestIndex = 0;
        var minDiff = Math.abs(slidePositions[0] - scrollLeft);

        for (var i = 1; i < slidePositions.length; i++) {
          var diff = Math.abs(slidePositions[i] - scrollLeft);
          if (diff < minDiff) {
            minDiff = diff;
            closestIndex = i;
          }
        }

        currentIndex = closestIndex + 1;
        if (currentIndex >= slidePositions.length) {
          currentIndex = slidePositions.length - 1;
        }

        var target = slidePositions[currentIndex];

        // 目标不要超过最大可滚动值，否则会追一个“到不了”的位置
        if (target > maxScrollLeft) {
          target = maxScrollLeft;
        }

        if (viewport.scrollTo) {
          viewport.scrollTo({
            left: target,
            behavior: 'smooth'
          });
        } else {
          viewport.scrollLeft = target;
        }
      }

      timer = setInterval(step, interval);
      container._groupCarouselAutoScrollTimer = timer;

      // 监听尺寸变化，重新计算 slide 位置（防止响应式宽度改变）
      if ('ResizeObserver' in window) {
        var ro = new ResizeObserver(function() {
          computePositions();
        });
        ro.observe(track);
        container._groupCarouselResizeObserver = ro;
      } else {
        window.addEventListener('resize', computePositions);
      }
    }

    function initAllGroupCarousels(root) {
      var scope = root || document;
      var containers = scope.querySelectorAll('.group-carousel-block');
      if (!containers || !containers.length) return;

      for (var i = 0; i < containers.length; i++) {
        initAutoScrollForCarousel(containers[i]);
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      initAllGroupCarousels();
    });

    document.addEventListener('shopify:section:load', function(event) {
      initAllGroupCarousels(event.target);
    });
  })();
{% endjavascript %}

{% schema %}
{
  "name": "Group carousel",
  "tag": null,
  "blocks": [
    {
      "type": "@theme"
    },
    {
      "type": "@app"
    },
    {
      "type": "_divider"
    }
  ],
  "settings": [
    {
      "type": "header",
      "content": "t:content.layout"
    },
    {
      "type": "select",
      "id": "content_direction",
      "label": "t:settings.direction",
      "options": [
        {
          "value": "column",
          "label": "t:options.vertical"
        },
        {
          "value": "row",
          "label": "t:options.horizontal"
        }
      ],
      "default": "column"
    },
    {
      "type": "checkbox",
      "id": "vertical_on_mobile",
      "label": "t:settings.vertical_on_mobile",
      "default": true,
      "visible_if": "{{ block.settings.content_direction == 'row' }}"
    },
    {
      "type": "select",
      "id": "horizontal_alignment",
      "label": "t:settings.alignment",
      "options": [
        {
          "value": "flex-start",
          "label": "t:options.left"
        },
        {
          "value": "center",
          "label": "t:options.center"
        },
        {
          "value": "flex-end",
          "label": "t:options.right"
        },
        {
          "value": "space-between",
          "label": "t:options.space_between"
        }
      ],
      "default": "flex-start",
      "visible_if": "{{ block.settings.content_direction == 'row' }}"
    },
    {
      "type": "select",
      "id": "vertical_alignment",
      "label": "t:settings.position",
      "options": [
        {
          "value": "flex-start",
          "label": "t:options.top"
        },
        {
          "value": "center",
          "label": "t:options.center"
        },
        {
          "value": "flex-end",
          "label": "t:options.bottom"
        }
      ],
      "default": "center",
      "visible_if": "{{ block.settings.content_direction == 'row' }}"
    },
    {
      "type": "checkbox",
      "id": "align_baseline",
      "label": "t:settings.align_baseline",
      "default": false,
      "visible_if": "{{ block.settings.vertical_alignment == 'flex-end' }}"
    },
    {
      "type": "select",
      "id": "horizontal_alignment_flex_direction_column",
      "label": "t:settings.alignment",
      "options": [
        {
          "value": "flex-start",
          "label": "t:options.left"
        },
        {
          "value": "center",
          "label": "t:options.center"
        },
        {
          "value": "flex-end",
          "label": "t:options.right"
        }
      ],
      "default": "flex-start",
      "visible_if": "{{ block.settings.content_direction != 'row' }}"
    },
    {
      "type": "select",
      "id": "vertical_alignment_flex_direction_column",
      "label": "t:settings.position",
      "options": [
        {
          "value": "flex-start",
          "label": "t:options.top"
        },
        {
          "value": "center",
          "label": "t:options.center"
        },
        {
          "value": "flex-end",
          "label": "t:options.bottom"
        },
        {
          "value": "space-between",
          "label": "t:options.space_between"
        }
      ],
      "default": "center",
      "visible_if": "{{ block.settings.content_direction == 'column' }}"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "t:settings.gap",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 12
    },
    {
      "type": "range",
      "id": "slide_width",
      "label": "Slide width (desktop & mobile)",
      "min": 30,
      "max": 100,
      "step": 5,
      "unit": "%",
      "default": 100
    },
    {
      "type": "checkbox",
      "id": "show_scrollbar",
      "label": "Show scrollbar",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "auto_scroll_enabled",
      "label": "Enable auto scroll",
      "default": false
    },
    {
      "type": "range",
      "id": "auto_scroll_interval",
      "label": "Auto scroll interval (seconds)",
      "min": 2,
      "max": 20,
      "step": 1,
      "unit": "s",
      "default": 4,
      "visible_if": "{{ block.settings.auto_scroll_enabled }}"
    },

    {
      "type": "header",
      "content": "t:content.size"
    },
    {
      "type": "select",
      "id": "width",
      "label": "t:settings.width",
      "options": [
        {
          "value": "fit-content",
          "label": "t:options.fit_content"
        },
        {
          "value": "fill",
          "label": "t:options.fill"
        },
        {
          "value": "custom",
          "label": "t:options.custom"
        }
      ],
      "default": "fill"
    },
    {
      "type": "range",
      "id": "custom_width",
      "label": "t:settings.custom_width",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "default": 100,
      "visible_if": "{{ block.settings.width == 'custom' }}"
    },
    {
      "type": "select",
      "id": "width_mobile",
      "label": "t:settings.width_mobile",
      "options": [
        {
          "value": "fit-content",
          "label": "t:options.fit_content"
        },
        {
          "value": "fill",
          "label": "t:options.fill"
        },
        {
          "value": "custom",
          "label": "t:options.custom"
        }
      ],
      "default": "fill"
    },
    {
      "type": "range",
      "id": "custom_width_mobile",
      "label": "t:settings.custom_width",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "default": 100,
      "visible_if": "{{ block.settings.width_mobile == 'custom' }}"
    },
    {
      "type": "select",
      "id": "height",
      "label": "t:settings.height",
      "options": [
        {
          "value": "fit",
          "label": "t:options.fit_content"
        },
        {
          "value": "fill",
          "label": "t:options.fill"
        },
        {
          "value": "custom",
          "label": "t:options.custom"
        }
      ],
      "default": "fit"
    },
    {
      "type": "range",
      "id": "custom_height",
      "label": "t:settings.custom_height",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "default": 100,
      "visible_if": "{{ block.settings.height == 'custom' }}"
    },
    {
      "type": "header",
      "content": "t:content.appearance"
    },
    {
      "type": "checkbox",
      "id": "inherit_color_scheme",
      "label": "t:settings.inherit_color_scheme",
      "default": true
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "scheme-1",
      "visible_if": "{{ block.settings.inherit_color_scheme == false }}"
    },
    {
      "type": "select",
      "id": "background_media",
      "label": "t:settings.background_media",
      "options": [
        {
          "value": "none",
          "label": "t:options.none"
        },
        {
          "value": "image",
          "label": "t:options.image"
        },
        {
          "value": "video",
          "label": "t:options.video"
        }
      ],
      "default": "none"
    },
    {
      "type": "video",
      "id": "video",
      "label": "t:settings.video",
      "visible_if": "{{ block.settings.background_media == 'video' }}"
    },
    {
      "type": "select",
      "id": "video_position",
      "label": "t:settings.video_position",
      "options": [
        {
          "value": "cover",
          "label": "t:options.cover"
        },
        {
          "value": "contain",
          "label": "t:options.contain"
        }
      ],
      "default": "cover",
      "visible_if": "{{ block.settings.background_media == 'video' }}"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "t:settings.image",
      "visible_if": "{{ block.settings.background_media == 'image' }}"
    },
    {
      "type": "select",
      "id": "background_image_position",
      "label": "t:settings.image_position",
      "options": [
        {
          "value": "cover",
          "label": "t:options.cover"
        },
        {
          "value": "fit",
          "label": "t:options.fit"
        }
      ],
      "default": "cover",
      "visible_if": "{{ block.settings.background_media == 'image' }}"
    },
    {
      "type": "select",
      "id": "border",
      "label": "t:settings.borders",
      "options": [
        {
          "value": "none",
          "label": "t:options.none"
        },
        {
          "value": "solid",
          "label": "t:options.solid"
        }
      ],
      "default": "none"
    },
    {
      "type": "range",
      "id": "border_width",
      "min": 0,
      "max": 10,
      "step": 0.5,
      "unit": "px",
      "label": "t:settings.border_width",
      "default": 1,
      "visible_if": "{{ block.settings.border != 'none' }}"
    },
    {
      "type": "range",
      "id": "border_opacity",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "t:settings.border_opacity",
      "default": 100,
      "visible_if": "{{ block.settings.border != 'none' }}"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "t:settings.border_radius",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "checkbox",
      "id": "toggle_overlay",
      "label": "t:settings.background_overlay"
    },
    {
      "type": "color",
      "id": "overlay_color",
      "label": "t:settings.overlay_color",
      "alpha": true,
      "default": "#00000026",
      "visible_if": "{{ block.settings.toggle_overlay }}"
    },
    {
      "type": "select",
      "id": "overlay_style",
      "label": "t:settings.overlay_style",
      "options": [
        {
          "value": "solid",
          "label": "t:options.solid"
        },
        {
          "value": "gradient",
          "label": "t:options.gradient"
        }
      ],
      "default": "solid",
      "visible_if": "{{ block.settings.toggle_overlay }}"
    },
    {
      "type": "select",
      "id": "gradient_direction",
      "label": "t:settings.gradient_direction",
      "options": [
        {
          "value": "to top",
          "label": "t:options.up"
        },
        {
          "value": "to bottom",
          "label": "t:options.down"
        }
      ],
      "default": "to top",
      "visible_if": "{{ block.settings.toggle_overlay and block.settings.overlay_style == 'gradient' }}"
    },
    {
      "type": "header",
      "content": "t:content.block_link"
    },
    {
      "type": "url",
      "id": "link",
      "label": "t:settings.link"
    },
    {
      "type": "checkbox",
      "id": "open_in_new_tab",
      "label": "t:settings.open_new_tab",
      "default": false
    },
    {
      "type": "text",
      "id": "placeholder",
      "label": "t:settings.image",
      "visible_if": "{{ false }}"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-start",
      "label": "t:settings.left",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-end",
      "label": "t:settings.right",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "Group carousel",
      "category": "t:categories.layout"
    }
  ]
}
{% endschema %}
