{%- comment -%}
  Product carousel block — vBPC-1.0.0
  - 手动选择一组产品，横向滑动展示
  - 适合放在 Group、Multicolumn 之类的容器里作为一个 block 使用
{%- endcomment -%}

{%- liquid
  assign selected_products = block.settings.products
-%}

{%- if selected_products != blank and selected_products.size > 0 -%}
  <div
    class="block-product-carousel"
    data-block-product-carousel
    style="
      --bpc-slide-width: {{ block.settings.slide_width }}px;
      --bpc-gap: {{ block.settings.columns_gap }}px;
    "
    {{ block.shopify_attributes }}
  >
    {%- if block.settings.show_heading and block.settings.heading != blank -%}
      <div class="block-product-carousel__heading">
        <h3>{{ block.settings.heading }}</h3>
      </div>
    {%- endif -%}

    <div class="block-product-carousel__inner">
      {%- if block.settings.show_nav -%}
        <button
          type="button"
          class="block-product-carousel__nav block-product-carousel__nav--prev"
          aria-label="{{ 'accessibility.slideshow_previous' | t }}"
          data-bpc-prev
        >
          ‹
        </button>
      {%- endif -%}

      <div class="block-product-carousel__viewport" data-bpc-viewport>
        <div class="block-product-carousel__track">
          {%- for product in selected_products -%}
            <div class="block-product-carousel__item">
              {%- # theme-check-disable UniqueStaticBlockId -%}
                {%- content_for 'block',
                  type: '_product-card',
                  id: 'static-product-card',
                  closest.product: product
                -%}
              {%- # theme-check-enable UniqueStaticBlockId -%}
            </div>
          {%- endfor -%}
        </div>
      </div>

      {%- if block.settings.show_nav -%}
        <button
          type="button"
          class="block-product-carousel__nav block-product-carousel__nav--next"
          aria-label="{{ 'accessibility.slideshow_next' | t }}"
          data-bpc-next
        >
          ›
        </button>
      {%- endif -%}
    </div>
  </div>
{%- else -%}
  <div class="block-product-carousel block-product-carousel--empty" {{ block.shopify_attributes }}>
    <p style="opacity:.6;">Select products in block settings.</p>
  </div>
{%- endif -%}

<style>
  .block-product-carousel {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .block-product-carousel__heading h3 {
    margin: 0;
  }

  .block-product-carousel__inner {
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    column-gap: 0.75rem;
  }

  .block-product-carousel__viewport {
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
  }

  .block-product-carousel__track {
    display: flex;
    gap: var(--bpc-gap, 16px);
  }

  .block-product-carousel__item {
    flex: 0 0 var(--bpc-slide-width, 260px);
    min-width: var(--bpc-slide-width, 260px);
    scroll-snap-align: start;
  }

  .block-product-carousel__nav {
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 1.6rem;
    line-height: 1;
    padding: 0.25rem 0.4rem;
  }

  .block-product-carousel--empty {
    opacity: .7;
  }

  @media (max-width: 749px) {
    .block-product-carousel__inner {
      grid-template-columns: 1fr;
      row-gap: 0.5rem;
    }

    .block-product-carousel__nav {
      order: 2;
      justify-self: center;
    }

    .block-product-carousel__viewport {
      order: 1;
    }

    .block-product-carousel__item {
      flex-basis: 80%;
      min-width: 80%;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('[data-block-product-carousel]').forEach(function (root) {
      var viewport = root.querySelector('[data-bpc-viewport]');
      var prev = root.querySelector('[data-bpc-prev]');
      var next = root.querySelector('[data-bpc-next]');
      if (!viewport || !prev || !next) return;

      function getStep () {
        var item = viewport.querySelector('.block-product-carousel__item');
        if (!item) return viewport.clientWidth;
        var rect = item.getBoundingClientRect();
        return rect.width + (parseFloat(getComputedStyle(item).marginRight) || 0);
      }

      prev.addEventListener('click', function () {
        viewport.scrollBy({ left: -getStep(), behavior: 'smooth' });
      });

      next.addEventListener('click', function () {
        viewport.scrollBy({ left: getStep(), behavior: 'smooth' });
      });
    });
  });
</script>

{% schema %}
{
  "name": "Product carousel",
  "settings": [
    {
      "type": "product_list",
      "id": "products",
      "label": "Products"
    },
    {
      "type": "checkbox",
      "id": "show_heading",
      "label": "Show heading",
      "default": false
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Featured products",
      "placeholder": "Heading",
      "info": "Shown only when “Show heading” is enabled."
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "slide_width",
      "label": "Slide width",
      "min": 150,
      "max": 600,
      "step": 10,
      "unit": "px",
      "default": 260
    },
    {
      "type": "range",
      "id": "columns_gap",
      "label": "Horizontal gap",
      "min": 0,
      "max": 64,
      "step": 2,
      "unit": "px",
      "default": 16
    },
    {
      "type": "checkbox",
      "id": "show_nav",
      "label": "Show navigation arrows",
      "default": true
    }
  ]
}
{% endschema %}
